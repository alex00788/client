# PersonalDataBlockComponent

## Описание

`PersonalDataBlockComponent` - это компонент для отображения персональных данных пользователя и загрузки фотографий организации. Компонент показывает информацию о текущем пользователе, его роли, выбранной организации, балансе и остатке записей. Также предоставляет функциональность загрузки логотипа организации для администраторов.

**Покрытие тестами: 61 тест (37 unit + 24 интеграционных)**

## Основной функционал

### Ключевые возможности
- ✅ **Отображение данных пользователя** - имя, роль, организация
- ✅ **Загрузка фото организации** - только для администраторов организации
- ✅ **Отображение баланса** - показ текущего баланса и остатка записей
- ✅ **Условная видимость** - разные данные для разных типов пользователей
- ✅ **Управление состоянием** - корректная работа с подписками и очистка ресурсов
- ✅ **Интеграция с API** - загрузка файлов через ApiService

### Архитектурные особенности
- **Standalone компонент** - независимая модульная архитектура
- **File Upload** - обработка загрузки файлов через FormData
- **RxJS интеграция** - управление подписками через takeUntil
- **Event Emitter** - уведомление родительского компонента о загрузке фото
- **Управление памятью** - автоматическая очистка подписок через destroyed$

## Структура файлов

```
personal-data-block/
├── personal-data-block.component.ts       # Основная логика компонента
├── personal-data-block.component.html     # HTML шаблон
├── personal-data-block.component.css      # Стили для компонента
├── personal-data-block.component.spec.ts  # Unit тесты (37 тестов)
├── personal-data-block.integration.spec.ts # Интеграционные тесты (24 теста)
└── README.md                               # Документация компонента
```

## Публичные методы и свойства

### Свойства
```typescript
photoAdded: EventEmitter<any>         # Событие загрузки фото
personalBlockService: PersonalBlockService  # Сервис управления блоком
dateService: DateService              # Сервис данных и дат
apiService: ApiService                # Сервис API запросов
```

### Методы
```typescript
ngOnInit(): void                      # Инициализация компонента
loadLabelOrg(event: any): void        # Обработка загрузки файла
ngOnDestroy(): void                   # Очистка ресурсов и подписок
```

### Приватные методы
```typescript
createFormData(files: FileList): void # Создание FormData из файлов
loadPhotoLabelOrg(): void             # Загрузка фото через API
```

## Зависимости

### Внешние сервисы
- **PersonalBlockService** - управление состоянием персонального блока
- **DateService** - получение данных пользователя и организации
- **ApiService** - загрузка фотографий организации

### Компоненты и директивы
- **AsyncPipe** - работа с Observable в шаблоне
- **NgIf** - условное отображение элементов
- **TranslateMonthPipe** - преобразование месяцев

## Алгоритм работы

### Инициализация компонента
1. **Создание компонента** - инициализация EventEmitter и Subject
2. **Инъекция сервисов** - получение доступа к необходимым сервисам
3. **Инициализация Subject** - создание destroyed$ для управления подписками

### Загрузка фото организации
1. **Выбор файла** - пользователь выбирает файл через input
2. **Обработка события** - вызов loadLabelOrg с файловым событием
3. **Создание FormData** - формирование данных для отправки (файл + orgId)
4. **API запрос** - отправка FormData через ApiService.loadPhotoLabelOrg
5. **Обработка ответа** - эмит события photoAdded при успехе
6. **Управление подписками** - использование takeUntil для автоматической отписки

### Уничтожение компонента
1. **Завершение Subject** - вызов destroyed$.next() и destroyed$.complete()
2. **Очистка подписок** - автоматическая отписка от всех Observable через takeUntil

## Детальное описание тестов

### Unit тесты (37 тестов)

#### Создание и инициализация компонента (5 тестов)
- ✅ Успешное создание компонента
- ✅ Инъекция всех требуемых сервисов
- ✅ Инициализация Subject для destroyed$
- ✅ Создание EventEmitter для photoAdded
- ✅ Инициализация formData как undefined

#### ngOnInit (2 теста)
- ✅ Выполнение ngOnInit без ошибок
- ✅ Вызов lifecycle hook ngOnInit

#### Метод loadLabelOrg (4 теста)
- ✅ Вызов createFormData с event.target.files
- ✅ Обработка null события
- ✅ Обработка события с null target
- ✅ Обработка события с null files

#### Метод createFormData (5 тестов)
- ✅ Создание FormData с файлом и orgId
- ✅ Обработка пустого списка файлов
- ✅ Обработка null списка файлов
- ✅ Использование правильного orgId из dateService
- ✅ Вызов loadPhotoLabelOrg после создания FormData

#### Метод loadPhotoLabelOrg (5 тестов)
- ✅ Вызов apiService.loadPhotoLabelOrg с formData
- ✅ Эмит события photoAdded при успешной загрузке
- ✅ Graceful обработка ошибок API
- ✅ Использование takeUntil с destroyed$ для управления подписками
- ✅ Отсутствие эмита photoAdded при уничтожении компонента

#### ngOnDestroy (3 теста)
- ✅ Завершение работы subject destroyed$
- ✅ Предотвращение утечек памяти
- ✅ Обработка множественных вызовов destroy

#### Интеграция загрузки файлов (3 теста)
- ✅ Полный поток загрузки файла
- ✅ Обработка различных типов файлов
- ✅ Обработка больших файлов

#### EventEmitter photoAdded (3 тестов)
- ✅ Эмит без данных
- ✅ Определение как EventEmitter
- ✅ Декорирование @Output

#### Граничные случаи и обработка ошибок (4 теста)
- ✅ Обработка undefined formData в loadPhotoLabelOrg
- ✅ Обработка timeout ошибок API
- ✅ Обработка сетевых ошибок
- ✅ Обработка множественных быстрых выборов файлов

#### Интеграция с сервисами (4 теста)
- ✅ Интеграция с PersonalBlockService
- ✅ Интеграция с DateService
- ✅ Интеграция с ApiService
- ✅ Использование dateService.idSelectedOrg.value для orgId

### Интеграционные тесты (24 теста)

#### Полный жизненный цикл компонента (2 теста)
- ✅ Инициализация и корректное отображение
- ✅ Полный цикл от создания до уничтожения

#### Интеграция с сервисами (3 теста)
- ✅ Интеграция с реальным PersonalBlockService
- ✅ Интеграция с реальным DateService
- ✅ Интеграция с реальным ApiService

#### Реальная интеграция загрузки файлов (3 теста)
- ✅ Вызов реального метода ApiService.loadPhotoLabelOrg
- ✅ Graceful обработка реальных ошибок API
- ✅ Работа с различными типами файлов

#### Пользовательские взаимодействия (2 теста)
- ✅ Последовательные загрузки файлов
- ✅ Быстрые выборы файлов

#### Поток данных (2 теста)
- ✅ Сохранение целостности данных при операциях
- ✅ Корректное создание FormData

#### Обработка ошибок (2 теста)
- ✅ Graceful обработка ошибок сервисов
- ✅ Продолжение работы после ошибок сервисов

#### Управление памятью (2 теста)
- ✅ Корректная очистка подписок при уничтожении
- ✅ Обработка множественных циклов init/destroy

#### Производительность (2 теста)
- ✅ Эффективная обработка высокочастотных операций
- ✅ Поддержание производительности при больших файлах

## Использование

### Базовое использование
```html
<app-personal-data-block 
  (photoAdded)="handlePhotoAdded()">
</app-personal-data-block>
```

### Обработка событий
```typescript
handlePhotoAdded() {
  // Обновить отображение фото
  this.refreshPhoto();
  // Показать уведомление
  this.showNotification('Фото загружено');
}
```

## Особенности работы с файлами

### Поддерживаемые форматы
- **image/png** - PNG изображения
- **image/jpeg** - JPEG изображения

### Ограничения
- Загрузка доступна только администраторам организации
- Поддерживается загрузка только одного файла за раз
- Размер файла ограничен настройками сервера

### Обработка файлов
```typescript
// Создание FormData
const formData = new FormData();
formData.append('file', file, file.name);
formData.append('orgId', this.dateService.idSelectedOrg.value);

// Отправка на сервер
this.apiService.loadPhotoLabelOrg(formData)
  .pipe(takeUntil(this.destroyed$))
  .subscribe(() => this.photoAdded.emit());
```

## Условная видимость

### Для администраторов организации
- Отображается блок загрузки фото
- Показывается роль пользователя
- Имя и фамилия пользователя

### Для простых пользователей
- Показывается выбранная организация
- Отображается баланс (0 руб)
- Показывается остаток записей

### Общие элементы
- Имя и фамилия пользователя
- Кнопка переключения данных

## Производительность

### Оптимизации
- Использование `takeUntil` для автоматической отписки от подписок
- Минимальное количество DOM манипуляций
- Эффективная работа с файлами через FormData

### Рекомендации
- Ограничивайте размер загружаемых файлов
- Используйте сжатые изображения
- Обрабатывайте ошибки загрузки gracefully

## Безопасность

### Валидация файлов
- Проверка типа файла (accept="image/png, image/jpeg")
- Передача orgId для привязки к организации
- Обработка ошибок загрузки

### API безопасность
- Файлы передаются через HTTPS
- Валидация на стороне сервера
- Ограничения по размеру файла

## Совместимость

### Версии Angular
- Angular 17+ (standalone компоненты)
- RxJS 7+
- File API

### Браузеры
- Chrome 90+ (File API)
- Firefox 88+ (File API)
- Safari 14+ (File API)
- Edge 90+ (File API)

## Известные ограничения

1. **Один файл за раз** - нет поддержки множественной загрузки
2. **Только изображения** - ограничение на PNG и JPEG форматы
3. **Административные права** - загрузка доступна только админам организации

## Планы развития

### Краткосрочные улучшения
- [ ] Предварительный просмотр изображения
- [ ] Прогресс-бар загрузки
- [ ] Валидация размера файла на клиенте

### Долгосрочные улучшения
- [ ] Поддержка drag & drop
- [ ] Обрезка изображений
- [ ] Множественная загрузка файлов
- [ ] Сжатие изображений на клиенте

## Поддержка

### Документация
- [Angular File Upload](https://angular.io/guide/file-upload)
- [FormData API](https://developer.mozilla.org/en-US/docs/Web/API/FormData)
- [File API](https://developer.mozilla.org/en-US/docs/Web/API/File)

### Контакты
Для вопросов по компоненту обращайтесь к команде разработки или создавайте issue в репозитории проекта.
