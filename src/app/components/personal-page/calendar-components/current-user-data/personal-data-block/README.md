# Personal Data Block Component

## Описание

`PersonalDataBlockComponent` - это Angular компонент, который отображает персональную информацию пользователя и предоставляет функциональность для загрузки фотографии организации (для администраторов).

## Функциональность

### Основные возможности

1. **Отображение информации о пользователе:**
   - Имя и фамилия текущего пользователя
   - Роль пользователя (Администратор, Клиент)
   - Название выбранной организации

2. **Управление фотографией организации (только для администраторов):**
   - Загрузка фотографии организации
   - Поддержка форматов JPEG и PNG
   - Автоматическая отправка на сервер

3. **Отображение финансовой информации (для клиентов):**
   - Баланс (в рублях)
   - Остаток записей

### Условное отображение

Компонент динамически отображает различные секции в зависимости от роли пользователя:

- **Администраторы организации:** Видят секцию загрузки фотографии
- **Обычные пользователи:** Видят информацию о балансе и оставшихся записях
- **Главные администраторы:** Видят расширенную информацию

## Архитектура

### Зависимости

- `PersonalBlockService` - управление состоянием персонального блока
- `DateService` - управление данными пользователя и организации
- `ApiService` - взаимодействие с сервером для загрузки файлов

### Компоненты

```typescript
@Component({
  selector: 'app-personal-data-block',
  standalone: true,
  imports: [AsyncPipe, NgIf, TranslateMonthPipe],
  templateUrl: './personal-data-block.component.html',
  styleUrl: './personal-data-block.component.css'
})
```

### Основные методы

- `loadLabelOrg(event: any)` - обработка выбора файла для загрузки
- `createFormData(files: FileList)` - создание FormData для отправки
- `loadPhotoLabelOrg()` - загрузка фотографии на сервер
- `ngOnInit()` - инициализация компонента
- `ngOnDestroy()` - очистка ресурсов

## Тестирование

### E2E тесты

Компонент покрыт комплексными E2E тестами, которые проверяют:

#### 1. Инициализация и отображение данных
- Корректное отображение имени пользователя
- Правильное отображение роли пользователя
- Отображение информации об организации для клиентов
- Отображение баланса и оставшихся средств

#### 2. Функциональность загрузки фотографий
- Отображение секции загрузки для администраторов
- Скрытие секции загрузки для обычных пользователей
- Обработка различных типов файлов (JPEG, PNG)
- Загрузка больших файлов
- Полный workflow загрузки файла

#### 3. Интеграция с сервисами
- Взаимодействие с PersonalBlockService
- Использование DateService для получения данных
- Интеграция с ApiService для загрузки файлов
- Обработка ошибок API

#### 4. Управление состоянием и производительность
- Обработка быстрых пользовательских взаимодействий
- Поддержание консистентности состояния
- Правильное управление жизненным циклом компонента
- Очистка памяти при уничтожении

#### 5. Обработка краевых случаев
- Обработка null/undefined значений
- Обработка пустых списков файлов
- Обработка отсутствующих данных пользователя
- Обработка сетевых таймаутов

### Запуск тестов

```bash
# Запуск всех тестов компонента
npm test -- --include="**/personal-data-block.e2e.spec.ts"

# Запуск с автоматическим перезапуском
npm test -- --include="**/personal-data-block.e2e.spec.ts"
```

### Покрытие тестами

- **Unit тесты:** 100% покрытие основных методов
- **E2E тесты:** 24 теста, покрывающих все сценарии использования
- **Интеграционные тесты:** Проверка взаимодействия с сервисами

## Использование

### В шаблоне

```html
<app-personal-data-block
  (photoAdded)="onPhotoAdded()">
</app-personal-data-block>
```

### В компоненте

```typescript
import { PersonalDataBlockComponent } from './personal-data-block.component';

export class ParentComponent {
  onPhotoAdded() {
    // Обработка события загрузки фотографии
    console.log('Фотография организации загружена');
  }
}
```

## События

### photoAdded

Событие, которое испускается после успешной загрузки фотографии организации.

```typescript
@Output() photoAdded: EventEmitter<any> = new EventEmitter<any>()
```

## Стилизация

Компонент использует CSS классы для стилизации:

- `.now` - основной контейнер
- `.titleNow` - заголовок с возможностью клика
- `.currentUser` - блок информации о пользователе
- `.currentUserNameOrg` - имя пользователя/организации
- `.addPhotoOrg` - секция загрузки фотографии
- `.uploadEmployeePhoto` - текст для загрузки фотографии
- `.inputPhotoOrgLabel` - поле ввода файла

## Безопасность

- Проверка роли пользователя перед отображением секции загрузки
- Валидация типов файлов (только изображения)
- Использование FormData для безопасной передачи файлов
- Автоматическая очистка ресурсов при уничтожении компонента

## Производительность

- Использование `takeUntil` для управления подписками
- Автоматическая отписка от Observable при уничтожении
- Оптимизированная обработка событий DOM
- Эффективное управление состоянием

## Совместимость

- Angular 17+
- Поддержка современных браузеров
- Responsive дизайн
- Поддержка TypeScript 5.3+

## Известные ограничения

- Загрузка только одного файла за раз
- Поддержка только форматов JPEG и PNG
- Размер файла ограничен настройками сервера

## Планы развития

- [ ] Добавление поддержки других форматов изображений
- [ ] Drag & Drop загрузка файлов
- [ ] Предварительный просмотр изображения
- [ ] Кроппинг изображений
- [ ] Сжатие изображений перед загрузкой
- [ ] Прогресс-бар загрузки
- [ ] Возможность загрузки нескольких файлов
