# SelectOrgToDisplayComponent

## Описание
`SelectOrgToDisplayComponent` - компонент для выбора и переключения между организациями в системе. Позволяет пользователям просматривать список доступных организаций, искать конкретные организации и переключаться между ними. Компонент интегрируется с сервисами для обновления данных календаря и управления состоянием пользователя.

## Основная функциональность
- Отображение текущей выбранной организации
- Переключение в режим выбора организации с поиском
- Поиск организаций по названию
- Выбор организации с автоматическим обновлением данных
- Сохранение выбранной организации в localStorage
- Обработка кликов вне компонента для закрытия выбора
- Интеграция с сервисами для обновления календарных данных

## Входные параметры
Компонент не принимает входные параметры через `@Input()`.

## Выходные параметры
- `orgWasChange: EventEmitter<any>` - событие изменения выбранной организации

## Зависимости
### Сервисы
- `DateService` - управление датами, состоянием выбранной организации и пользователя
- `DataCalendarService` - работа с календарными данными и проверка сотрудников организации

### Angular модули
- `NgForOf` - для итерации по списку организаций
- `AsyncPipe` - для работы с асинхронными данными
- `NgIf` - для условного отображения
- `FormsModule` - для работы с поисковым полем
- `ReactiveFormsModule` - для реактивных форм
- `FilterOrgPipe` - для фильтрации организаций по поисковому запросу

## Свойства компонента
- `searchOrgForRec: string` - строка поиска организаций
- `showSelectedOrg: boolean` - флаг отображения списка организаций
- `inputSearchOrgRef: ElementRef` - ссылка на поле поиска
- `destroyed$: Subject<void>` - субъект для управления подписками

## Основные методы

### `ngOnInit()`
Инициализирует компонент и подписывается на изменения в `currentOrgWasRenamed` для обновления данных об организации.

### `choiceOrgForRec(org: any)`
Выбирает организацию и выполняет полный цикл обновления:
- Переключает состояние сервисов
- Обновляет выбранную организацию
- Загружает календарные данные
- Проверяет наличие сотрудников
- Эмитит событие изменения организации
- Обновляет данные о выбранной организации

### `whenSwitchOrgCheckHasEmployees()`
Подписывается на изменения в списке пользователей выбранной организации и вызывает проверку наличия сотрудников.

### `refreshDataAboutOrg()`
Обновляет данные пользователя в localStorage с текущими значениями организации, роли и остатка средств.

### `changeOrg()`
Переключает в режим выбора организации с задержкой в 250мс для корректной обработки кликов.

### `onClick(event: Event)`
Обрабатывает клики вне компонента и закрывает выбор организации при потере фокуса.

### `ngOnDestroy()`
Очищает все подписки и предотвращает утечки памяти.

## Логика работы
1. При инициализации подписывается на изменения в переименовании организации
2. Отображает текущую выбранную организацию
3. При клике на организацию открывает список доступных организаций
4. Пользователь может искать организации через поле поиска
5. При выборе организации:
   - Обновляет состояние в `DateService`
   - Загружает календарные данные через `DataCalendarService`
   - Проверяет наличие сотрудников
   - Сохраняет выбор в localStorage
   - Эмитит событие для родительских компонентов
6. При клике вне компонента автоматически закрывает выбор

## Тестирование
Компонент покрыт тремя типами тестов:

### Unit тесты (`select-org-to-display.component.spec.ts`)
- **45 тестов** покрывают все методы и сценарии
- Тестируют изолированную логику компонента
- Проверяют корректность работы с мок-сервисами
- Покрывают граничные случаи и обработку ошибок
- Тестируют управление состоянием и жизненный цикл

### Интеграционные тесты (`select-org-to-display.integration.spec.ts`)
- **25 тестов** проверяют взаимодействие с реальными сервисами
- Тестируют синхронизацию данных между сервисами
- Проверяют жизненный цикл компонента
- Покрывают обработку ошибок сервисов
- Тестируют реальные пользовательские сценарии

### E2E тесты (`select-org-to-display.e2e.spec.ts`)
- **35 тестов** проверяют полные пользовательские сценарии
- Тестируют производительность и управление памятью
- Проверяют доступность и UX
- Покрывают сложные многошаговые сценарии
- Тестируют поиск, фильтрацию и навигацию

## Использование
```typescript
<app-select-org-to-display
  (orgWasChange)="onOrganizationChange($event)">
</app-select-org-to-display>
```

## Стили
Компонент использует CSS файл `select-org-to-display.component.css` для стилизации:
- `.selectOrgToDisplayClass` - основной контейнер выбора организации
- `.choiceTitleSelectOrg` - заголовок выбора организации
- `.searchOrg` - стили для поля поиска
- `.listOrg` - стили для списка организаций
- `.org-sClass` - стили для отдельной организации
- `.ownOrgClass` - стили для названия организации
- `.selectedOrg` - стили для выбранной организации
- `.titleSelectOrg` - стили для заголовка выбранной организации

## Зависимости Angular
- Angular Core
- RxJS (Subject, takeUntil, BehaviorSubject)
- Angular Common (NgForOf, AsyncPipe, NgIf)
- Angular Forms (FormsModule, ReactiveFormsModule)

## Архитектурные особенности
- Standalone компонент (не требует NgModule)
- Использует реактивное программирование с RxJS
- Правильное управление подписками с `takeUntil`
- Разделение ответственности между сервисами
- Автоматическое управление состоянием UI
- Интеграция с localStorage для персистентности

## Особенности реализации
- Использование `setTimeout` в `changeOrg()` для корректной обработки кликов
- `@HostListener` для глобального отслеживания кликов
- Автоматическое обновление данных при смене организации
- Проверка наличия сотрудников в выбранной организации
- Сохранение состояния пользователя в localStorage

## Производительность
- Эффективное управление подписками
- Автоматическая очистка ресурсов при уничтожении
- Оптимизированная работа с большими наборами данных
- Минимальное количество перерисовок UI

## Безопасность
- Валидация входных данных
- Безопасная работа с localStorage
- Обработка ошибок сервисов
- Защита от XSS через безопасную работу с DOM

