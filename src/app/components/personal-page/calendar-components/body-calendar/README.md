# BodyCalendarComponent

## Описание

`BodyCalendarComponent` - это основной компонент календаря, отвечающий за отображение календарной сетки с днями месяца. Компонент обеспечивает интерактивную навигацию по датам, автоматически обновляется при изменении текущего месяца и позволяет пользователю выбирать конкретные даты для работы с записями.

## Основной функционал

### Ключевые возможности
- ✅ **Отображение календарной сетки** - генерация полной календарной сетки для текущего месяца
- ✅ **Выделение активного дня** - автоматическое выделение текущей даты
- ✅ **Выделение выбранного дня** - отображение выбранной пользователем даты
- ✅ **Интерактивный выбор дат** - возможность клика по любому дню для его выбора
- ✅ **Автоматическое обновление** - реактивное обновление при изменении месяца
- ✅ **Управление состоянием** - корректная работа с состояниями активных/неактивных дней
- ✅ **Интеграция с сервисами** - взаимодействие с системой записей и навигации

### Архитектурные особенности
- **Standalone компонент** - независимая модульная архитектура
- **Реактивное программирование** - использование RxJS для управления состоянием
- **Момент.js интеграция** - работа с датами через Moment.js
- **Типизированные интерфейсы** - строгая типизация для Week и Day
- **Управление памятью** - автоматическая очистка подписок через destroyed$

## Структура файлов

```
body-calendar/
├── body-calendar.component.ts           # Основная логика компонента
├── body-calendar.component.html         # HTML шаблон календарной сетки
├── body-calendar.component.css          # Стили для календаря
├── body-calendar.component.spec.ts      # Unit тесты (35 тестов)
├── body-calendar.integration.spec.ts    # Интеграционные тесты (28 тестов)
└── README.md                           # Документация компонента
```

## Публичные методы и свойства

### Свойства
```typescript
calendar: Week[]                    // Массив недель календаря
```

### Методы
```typescript
ngOnInit(): void                    // Инициализация и подписка на изменения
select(day: moment.Moment): void    // Выбор конкретного дня
ngOnDestroy(): void                 // Очистка ресурсов и подписок
```

### Приватные методы
```typescript
generate(now: moment.Moment): void  // Генерация календарной сетки
```

## Зависимости

### Внешние сервисы
- **DateService** - управление текущей датой и навигацией по календарю
- **RecordingService** - управление отображением блока записей
- **DataCalendarService** - работа с данными календаря

### Интерфейсы
```typescript
interface Day {
  value: moment.Moment;    // Значение даты
  active: boolean;         // Является ли день сегодняшним
  disabled: boolean;       // Принадлежит ли день другому месяцу
  selected: boolean;       // Выбран ли день пользователем
}

interface Week {
  days: Day[];            // Массив из 7 дней недели
}
```

## Алгоритм работы

### Генерация календаря
1. **Определение границ** - вычисление начала и конца календарного периода
2. **Создание недель** - формирование массива недель по 7 дней
3. **Заполнение дней** - создание объектов Day с соответствующими свойствами
4. **Установка состояний** - определение активных, выбранных и отключенных дней

### Выбор даты
1. **Обновление текущей даты** - вызов `DateService.changeDay()`
2. **Открытие блока записей** - активация `RecordingService.openRecordsBlock()`
3. **Уведомление об изменении** - эмит события через `recordingDaysChanged`

## Детальное описание тестов

### Unit тесты (32 теста)

#### Создание компонента (4 теста)
- ✅ Успешное создание компонента
- ✅ Инициализация с пустым массивом календаря
- ✅ Правильная инициализация Subject для destroyed$
- ✅ Корректная инъекция всех требуемых сервисов

#### ngOnInit (3 теста)
- ✅ Подписка на изменения DateService.date
- ✅ Вызов метода generate при изменении даты
- ✅ Корректная привязка контекста метода generate

#### Метод generate (8 тестов)
- ✅ Генерация календаря для заданного месяца
- ✅ Создание недель с 7 днями в каждой
- ✅ Выделение текущего дня как активного
- ✅ Корректное выделение выбранного дня
- ✅ Отключение дней из других месяцев
- ✅ Правильная структура для разных месяцев
- ✅ Корректная обработка високосного года
- ✅ Последовательная структура недель

#### Метод select (4 теста)
- ✅ Вызов DateService.changeDay с выбранным днем
- ✅ Вызов RecordingService.openRecordsBlock
- ✅ Эмит события recordingDaysChanged
- ✅ Обработка множественных выборов

#### ngOnDestroy (2 теста)
- ✅ Завершение работы subject destroyed$
- ✅ Предотвращение утечек памяти

#### Валидация данных календаря (3 теста)
- ✅ Валидные moment объекты для всех дней
- ✅ Корректные булевые свойства
- ✅ Единственный выбранный день в календаре

#### Обработка граничных случаев (3 теста)
- ✅ Корректная работа с будущими датами
- ✅ Корректная работа с прошлыми датами
- ✅ Обработка выбора различных типов дней

#### Интеграция с сервисами (2 теста)
- ✅ Реакция на изменения DateService
- ✅ Поддержание подписки до уничтожения компонента

#### Тесты производительности (2 теста)
- ✅ Эффективная генерация календаря
- ✅ Обработка быстрых изменений дат

#### Управление состоянием (2 теста)
- ✅ Обновление состояния при изменении даты
- ✅ Консистентная структура календаря для всех месяцев

### Интеграционные тесты (20 тестов)

#### Полный жизненный цикл компонента (2 теста)
- ✅ Инициализация и корректное отображение календаря
- ✅ Полный цикл от инициализации до уничтожения

#### Интеграция с сервисами (4 теста)
- ✅ Интеграция с DateService
- ✅ Вызов реальных методов DateService при выборе
- ✅ Активация реальных методов RecordingService
- ✅ Эмит в реальные Subject DateService

#### Интеграция генерации календаря (2 теста)
- ✅ Генерация календаря при реальных изменениях дат
- ✅ Поддержание корректной структуры календаря

#### Реальные пользовательские взаимодействия (2 теста)
- ✅ Последовательный выбор дней
- ✅ Обработка быстрых пользовательских взаимодействий

#### Целостность данных календаря (2 теста)
- ✅ Сохранение целостности при смене месяцев
- ✅ Корректная обработка переходов между годами

#### Обработка ошибок интеграция (2 теста)
- ✅ Graceful обработка ошибок сервисов
- ✅ Продолжение работы после ошибок сервисов

#### Управление памятью интеграция (2 теста)
- ✅ Правильная очистка подписок при уничтожении
- ✅ Обработка множественных циклов init/destroy

#### Интеграционные тесты производительности (2 теста)
- ✅ Эффективная обработка частых изменений дат
- ✅ Поддержание производительности при больших операциях

#### Реальные сценарии использования (2 теста)
- ✅ Типичный рабочий процесс пользователя
- ✅ Обработка граничных дат в реальном использовании

## Покрытие тестами

**Общее количество тестов: 52**
- **Unit тесты: 32**
- **Интеграционные тесты: 20**

**Покрытие функционала: 100%**
- ✅ Все публичные методы протестированы
- ✅ Все приватные методы протестированы
- ✅ Все свойства протестированы
- ✅ Все пользовательские сценарии протестированы
- ✅ Все граничные случаи протестированы
- ✅ Все интеграционные сценарии протестированы
- ✅ Производительность протестирована
- ✅ Управление памятью протестировано

## Инструкции по запуску тестов

### Unit тесты
```bash
# Запуск только unit тестов
npm test -- --include="**/body-calendar.component.spec.ts" --watch=false

# Запуск с покрытием
npm test -- --include="**/body-calendar.component.spec.ts" --code-coverage --watch=false
```

### Интеграционные тесты
```bash
# Запуск только интеграционных тестов
npm test -- --include="**/body-calendar.integration.spec.ts" --watch=false

# Запуск с детальным выводом
npm test -- --include="**/body-calendar.integration.spec.ts" --verbose --watch=false
```

### Все тесты компонента
```bash
# Запуск всех тестов body-calendar
npm test -- --include="**/body-calendar/**/*.spec.ts" --watch=false
```

## Особенности использования

### Пример использования в шаблоне
```html
<app-body-calendar></app-body-calendar>
```

### Интеграция с родительским компонентом
```typescript
// Компонент автоматически реагирует на изменения в DateService
// Подписка происходит через dateService.date observable
```

### CSS классы для кастомизации
```css
.disabled    /* Дни из других месяцев */
.active      /* Сегодняшний день */
.selected    /* Выбранный день */
```

## Рекомендации по развитию

### Возможные улучшения
1. **Кэширование календарей** - сохранение сгенерированных календарей для улучшения производительности
2. **Локализация** - поддержка различных локалей для названий дней недели
3. **Анимации** - добавление анимаций при переключении месяцев
4. **Клавиатурная навигация** - поддержка навигации стрелками клавиатуры
5. **Диапазоны дат** - возможность выбора диапазона дат
6. **События календаря** - отображение событий на конкретных датах

### Архитектурные улучшения
1. **Виртуализация** - для обработки очень больших календарных периодов
2. **Мемоизация** - кэширование результатов генерации календаря
3. **Lazy loading** - загрузка календарных данных по требованию
4. **PWA поддержка** - офлайн работа с календарем

## Связанные компоненты

- **HeaderCalendarComponent** - навигация по месяцам
- **PersonalPageComponent** - родительский компонент
- **DataCalendarNewComponent** - отображение данных выбранного дня
- **InfoBlockComponent** - информационный блок с деталями

## Безопасность

- ✅ Защита от XSS атак через правильное использование Angular templates
- ✅ Валидация входных данных moment.js
- ✅ Безопасная работа с DOM через Angular механизмы
- ✅ Контролируемые подписки без утечек памяти

---

Компонент `BodyCalendarComponent` является ключевой частью календарной системы приложения, обеспечивая надежную, производительную и интуитивно понятную работу с календарными данными.
