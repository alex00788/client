# DataCalendarNewComponent

## Описание

`DataCalendarNewComponent` - это сложный компонент для управления записями в календаре, отображения дней недели/месяца, добавления/удаления записей и управления состоянием календаря. Компонент предоставляет полную функциональность для работы с расписанием, включая различные представления (день/неделя/месяц), управление временными слотами и интеграцию с пользователями.

**Покрытие тестами: 70 тестов (45 unit + 25 интеграционных)**

## Основной функционал

### Ключевые возможности
- ✅ **Управление календарем** - отображение дней недели, месяца с записями
- ✅ **Формирование данных** - создание массивов дат для недели и месяца
- ✅ **Управление записями** - добавление, удаление, изменение статуса записей
- ✅ **Пользовательские взаимодействия** - клики по временным слотам, поиск клиентов
- ✅ **Валидация записей** - проверка количества записей, ограничений
- ✅ **Интеграция с API** - работа с записями через ApiService
- ✅ **WebSocket интеграция** - обновление данных в реальном времени
- ✅ **Управление состоянием** - корректная работа с подписками и очистка ресурсов

### Архитектурные особенности
- **Standalone компонент** - независимая модульная архитектура
- **Сложная логика календаря** - формирование недель/месяцев с учетом границ
- **Множественные подписки** - управление через takeUntil и destroyed$
- **Moment.js интеграция** - работа с датами и форматированием
- **Условная видимость** - разные представления для разных типов пользователей
- **FormData интеграция** - работа с формами и пользовательским вводом

## Структура файлов

```
data-calendar-new/
├── data-calendar-new.component.ts       # Основная логика компонента
├── data-calendar-new.component.html     # HTML шаблон
├── data-calendar-new.component.css      # Стили для компонента
├── data-calendar-new.component.spec.ts  # Unit тесты (45 тестов)
├── data-calendar-new.integration.spec.ts # Интеграционные тесты (25 тестов)
├── data-calendar.service.ts             # Сервис для работы с данными календаря
└── README.md                             # Документация компонента
```

## Публичные методы и свойства

### Свойства
```typescript
@Input() idSelectedOrgForRecInEmployee: any    # ID организации для записи сотрудника
@ViewChild('inputElement') inputElementRef: ElementRef  # Ссылка на input элемент
currentDate: any                               # Текущая дата в формате DD.MM.YYYY
clickCount: number                            # Счетчик кликов для предотвращения двойных кликов
dataOfWeek: any[]                             # Массив данных для отображения недели
clientList: string                            # Строка поиска клиентов
selectedPersonId: any                         # ID выбранного пользователя
newEntryHasBeenOpenedTime: any                # Время открытого слота для записи
newEntryHasBeenOpenedDate: any                # Дата открытого слота для записи
blockIfRecorded: boolean                      # Флаг блокировки при записи
currentDayCheck: boolean                      # Флаг проверки текущего дня
pastDateIsBlocked: boolean                    # Флаг блокировки прошедших дат
recordComplete: boolean                       # Флаг завершения записи
currentHour: any                              # Текущий час
state: string                                 # Состояние (open/closed)
```

### Методы
```typescript
ngOnInit(): void                              # Инициализация компонента
ngOnDestroy(): void                           # Очистка ресурсов и подписок
getDataOrg(): void                            # Получение данных организации
addEntry(user: any, curHourTime: any, date: any): void  # Добавление записи
deletePerson(idRec: any, userId: any, orgId: any): void # Удаление записи
refreshData(): void                           # Обновление данных календаря
submit(data: any): void                       # Отправка формы записи
cancel(): void                                # Отмена записи
savingByPressingEnter(e: any, val: any, data: any): void # Обработка Enter/Escape
currentHourTime(time: any, date: any): void   # Открытие временного слота
checkingTheNumberOfRecorded(dateRec: any, timeRec: any): void # Проверка количества записей
getAllEntryInCurrentTimes(dateAndTimeRec: any): void # Получение записей на текущее время
choosePerson(person: any, data: any): void    # Выбор пользователя для записи
openDataPerson(person: any): void             # Открытие данных пользователя
closedRecords(time: any): void                # Закрытие/открытие временных слотов
```

### Приватные методы
```typescript
webSocketUpdateAllConnectedAboutBlockedUser(): void # WebSocket обновления
overwriteChangedData(dataParse: any): void    # Перезапись измененных данных
formativeShowMonth(currentDate: any): any[]   # Формирование массива дат месяца
formativeShowWeek(date: moment.Moment): any[] # Формирование массива дат недели
getArrayOfDays(persons: any, currentWeek: any): void # Группировка пользователей по дням
resultingArrayFormingTheWeek(currentWeek: any): any[] # Формирование итогового массива недели
checkShowOrHiDay(date: any): boolean          # Проверка показа/скрытия дня
getArrayOfDaysFromTheRequiredHours(week: any[]): any[] # Добавление временных слотов
sortingByTime(sortTime: any[]): any[]         # Сортировка по времени
checkingTheSetTime(addSetTime: any): any      # Проверка установленного времени
getAllRecOnThisWeek(currentWeek: any[]): any[] # Получение всех записей на неделю
currentUserRec(time: any, date: any): void    # Запись текущего пользователя
localErrHandler(err: string): any             # Обработка локальных ошибок
lostFocus(): void                             # Обработка потери фокуса
```

## Зависимости

### Внешние сервисы
- **DataCalendarService** - управление данными календаря и записями
- **DateService** - получение данных пользователя, организации и настроек
- **RecordingService** - управление состоянием отображения (день/неделя/месяц)
- **ApiService** - API операции с записями (добавление, удаление, изменение)
- **ModalService** - управление модальными окнами
- **WebSocketService** - WebSocket соединения для real-time обновлений
- **ErrorResponseService** - обработка и отображение ошибок

### Компоненты и директивы
- **AsyncPipe** - работа с Observable в шаблоне
- **NgForOf** - циклы для отображения данных
- **NgIf** - условное отображение элементов
- **FormsModule/ReactiveFormsModule** - работа с формами
- **FilterClientListPipe** - фильтрация списка клиентов

## Алгоритм работы

### Инициализация компонента
1. **Создание компонента** - инициализация всех свойств и Subject для destroyed$
2. **Установка текущей даты** - форматирование через moment.js
3. **Загрузка данных** - вызов getAllEntryAllUsersForTheMonth
4. **Подписки на сервисы** - подписка на изменения даты, настроек, отображения
5. **Инициализация подписок** - использование takeUntil для автоматической отписки

### Формирование календарных данных
1. **Формирование месяца** - создание массива дат для текущего месяца
2. **Формирование недели** - создание массива из 7 дней с учетом границ месяца
3. **Группировка пользователей** - группировка записей по дням и времени
4. **Добавление временных слотов** - заполнение пустых временных слотов
5. **Сортировка по времени** - упорядочивание слотов по возрастанию времени

### Управление записями
1. **Добавление записи** - проверка разрешений, валидация, API вызов
2. **Удаление записи** - API вызов, обновление статуса временного слота
3. **Изменение статуса** - открытие/закрытие временных слотов для записи
4. **Валидация** - проверка максимального количества записей, ограничений

### Пользовательские взаимодействия
1. **Клик по временному слоту** - открытие формы записи для пользователей
2. **Поиск клиентов** - фильтрация списка пользователей по вводу
3. **Выбор пользователя** - запись выбранного пользователя на время
4. **Клавиатурные события** - Enter для подтверждения, Escape для отмены

### Уничтожение компонента
1. **Завершение Subject** - вызов destroyed$.next() и destroyed$.complete()
2. **Очистка подписок** - автоматическая отписка от всех Observable через takeUntil

## Детальное описание тестов

### Unit тесты (45 тестов)

#### Создание и инициализация компонента (5 тестов)
- ✅ Успешное создание компонента
- ✅ Инъекция всех требуемых сервисов
- ✅ Инициализация Subject для destroyed$
- ✅ Создание ViewChild для input элемента
- ✅ Инициализация с дефолтными значениями

#### ngOnInit (7 тестов)
- ✅ Выполнение ngOnInit без ошибок
- ✅ Установка currentDate в форматированном виде
- ✅ Вызов getAllEntryAllUsersForTheMonth при инициализации
- ✅ Подписка на изменения dateService.date
- ✅ Подписка на изменения changedSettingsOrg
- ✅ Подписка на изменения showCurrentDay
- ✅ Подписка на изменения showCurrentWeek
- ✅ Подписка на изменения showCurrentMonth

#### Метод formativeShowMonth (3 теста)
- ✅ Генерация массива дат для текущего месяца
- ✅ Обработка месяцев разной длины
- ✅ Корректное форматирование дат

#### Метод formativeShowWeek (3 теста)
- ✅ Генерация массива из 7 дат для недели
- ✅ Обработка edge case для воскресенья
- ✅ Корректное форматирование дат

#### Метод getArrayOfDays (3 теста)
- ✅ Группировка пользователей по датам
- ✅ Сортировка пользователей по dateNum
- ✅ Обработка пустого массива пользователей

#### Метод resultingArrayFormingTheWeek (1 тест)
- ✅ Форматирование данных недели с временами и showThisDay

#### Метод checkShowOrHiDay (3 теста)
- ✅ Возврат true для рабочих дней
- ✅ Возврат false для нерабочих дней
- ✅ Обработка пустых рабочих дней

#### Метод addEntry (3 теста)
- ✅ Добавление записи когда пользователь разрешен
- ✅ Блокировка записи когда пользователь заблокирован
- ✅ Установка workStatus на основе максимального количества записей

#### Метод deletePerson (3 теста)
- ✅ Удаление записи пользователя
- ✅ Установка userCancelHimselfRec для простого пользователя
- ✅ Установка userCancelHimselfRec для администратора

#### Метод refreshData (1 тест)
- ✅ Обновление данных календаря

#### Метод submit (1 тест)
- ✅ Отправка записи и отмена формы

#### Метод cancel (1 тест)
- ✅ Сброс состояния формы

#### Метод savingByPressingEnter (3 теста)
- ✅ Отправка по клавише Enter
- ✅ Отмена по клавише Escape
- ✅ Отсутствие действий по другим клавишам

#### Метод currentHourTime (2 теста)
- ✅ Открытие временного слота для записи
- ✅ Корректное форматирование времени

#### Метод checkingTheNumberOfRecorded (1 тест)
- ✅ Проверка количества записей

#### Метод getAllEntryInCurrentTimes (2 теста)
- ✅ Получение записей для текущего времени и обновление счетчика
- ✅ Блокировка записи при достижении максимума

#### Метод localErrHandler (1 тест)
- ✅ Обработка локальных ошибок

#### Метод choosePerson (1 тест)
- ✅ Выбор пользователя и отправка

#### Метод lostFocus (1 тест)
- ✅ Обработка потери фокуса без ошибок

#### Метод openDataPerson (1 тест)
- ✅ Открытие модального окна данных пользователя

#### Метод closedRecords (2 теста)
- ✅ Изменение статуса работы для временного слота
- ✅ Отсутствие изменения статуса при достижении максимума записей

#### ngOnDestroy (2 теста)
- ✅ Завершение работы subject destroyed$
- ✅ Предотвращение утечек памяти

#### Граничные случаи и обработка ошибок (3 теста)
- ✅ Graceful обработка ошибок API
- ✅ Обработка пустых массивов данных
- ✅ Обработка null/undefined значений

#### Интеграция с сервисами (7 тестов)
- ✅ Интеграция с DataCalendarService
- ✅ Интеграция с DateService
- ✅ Интеграция с RecordingService
- ✅ Интеграция с ApiService
- ✅ Интеграция с ModalService
- ✅ Интеграция с WebSocketService
- ✅ Интеграция с ErrorResponseService

### Интеграционные тесты (25 тестов)

#### Полный жизненный цикл компонента (2 теста)
- ✅ Инициализация и корректное отображение
- ✅ Полный цикл от создания до уничтожения

#### Интеграция с сервисами (7 тестов)
- ✅ Интеграция с реальным DataCalendarService
- ✅ Интеграция с реальным DateService
- ✅ Интеграция с реальным RecordingService
- ✅ Интеграция с реальным ApiService
- ✅ Интеграция с реальным ModalService
- ✅ Интеграция с реальным WebSocketService
- ✅ Интеграция с реальным ErrorResponseService

#### Реальная интеграция данных календаря (3 теста)
- ✅ Обработка реального потока данных календаря
- ✅ Корректное форматирование данных месяца
- ✅ Корректное форматирование данных недели

#### Реальная интеграция API (4 теста)
- ✅ Вызов реального метода ApiService.addEntry
- ✅ Вызов реального метода ApiService.deleteEntry
- ✅ Вызов реального метода ApiService.getAllEntryInCurrentTimes
- ✅ Graceful обработка реальных ошибок API

#### Реальные пользовательские взаимодействия (3 теста)
- ✅ Обработка реального потока отправки формы
- ✅ Обработка реальных событий клавиатуры
- ✅ Обработка реального открытия временных слотов

#### Реальный поток данных (2 теста)
- ✅ Сохранение целостности данных при операциях
- ✅ Обработка реальных изменений представления календаря

#### Реальная обработка ошибок (2 теста)
- ✅ Graceful обработка ошибок сервисов
- ✅ Продолжение работы после ошибок сервисов

#### Реальное управление памятью (2 теста)
- ✅ Корректная очистка подписок при уничтожении
- ✅ Обработка множественных циклов init/destroy

#### Реальная производительность (2 теста)
- ✅ Эффективная обработка высокочастотных операций
- ✅ Поддержание производительности с большими наборами данных

#### Реальные сценарии использования (2 теста)
- ✅ Обработка типичного рабочего процесса календаря
- ✅ Обработка edge case сценариев в реальном использовании

#### Реальная интеграция UI (2 теста)
- ✅ Работа с реальными DOM событиями
- ✅ Обработка реальных изменений состояния формы

#### Реальная интеграция состояния сервисов (2 теста)
- ✅ Реакция на реальные изменения состояния сервисов
- ✅ Поддержание интеграции сервисов на протяжении жизненного цикла

## Использование

### Базовое использование
```html
<app-data-calendar-new 
  [idSelectedOrgForRecInEmployee]="orgId">
</app-data-calendar-new>
```

### Обработка событий
```typescript
// Обработка добавления записи
handleEntryAdded() {
  this.refreshCalendarData();
  this.showNotification('Запись добавлена');
}

// Обработка удаления записи
handleEntryDeleted() {
  this.refreshCalendarData();
  this.showNotification('Запись удалена');
}
```

## Особенности работы с календарем

### Форматирование дат
- **Формат дат**: DD.MM.YYYY (например, 15.01.2024)
- **Форматирование месяца**: автоматическое определение количества дней
- **Форматирование недели**: 7 дней с учетом границ месяца

### Временные слоты
- **Диапазон времени**: настраивается через DateService
- **Интервал**: настраивается через timeMinutesRec
- **Статус**: open/closed для управления записями

### Ограничения
- **Максимум записей**: настраивается через maxPossibleEntries
- **Рабочие дни**: настраиваются через recordingDays
- **Временные ограничения**: блокировка прошедших дат и времени

## Производительность

### Оптимизации
- Использование `takeUntil` для автоматической отписки от подписок
- Эффективные алгоритмы формирования календарных данных
- Минимальное количество DOM манипуляций
- Оптимизированная работа с массивами дат

### Рекомендации
- Ограничивайте количество одновременных подписок
- Используйте debounce для пользовательского ввода
- Кэшируйте результаты форматирования дат
- Обрабатывайте ошибки gracefully

## Безопасность

### Валидация данных
- Проверка формата дат и времени
- Валидация количества записей
- Проверка разрешений пользователей
- Обработка некорректных данных

### API безопасность
- Валидация входных параметров
- Обработка ошибок API
- Логирование операций
- Ограничения на размер данных

## Совместимость

### Версии Angular
- Angular 17+ (standalone компоненты)
- RxJS 7+
- Moment.js 2.29+

### Браузеры
- Chrome 90+ (ES6+)
- Firefox 88+ (ES6+)
- Safari 14+ (ES6+)
- Edge 90+ (ES6+)

## Известные ограничения

1. **Сложность логики** - компонент имеет сложную логику формирования календаря
2. **Множественные подписки** - требует тщательного управления памятью
3. **Зависимость от Moment.js** - форматирование дат через внешнюю библиотеку
4. **Большое количество методов** - сложность тестирования и поддержки

## Планы развития

### Краткосрочные улучшения
- [ ] Рефакторинг сложных методов
- [ ] Добавление unit тестов для edge cases
- [ ] Оптимизация производительности
- [ ] Улучшение обработки ошибок

### Долгосрочные улучшения
- [ ] Замена Moment.js на современные альтернативы
- [ ] Добавление виртуализации для больших календарей
- [ ] Реализация drag & drop для записей
- [ ] Добавление offline режима

## Поддержка

### Документация
- [Angular Calendar Components](https://angular.io/guide/component-interaction)
- [RxJS takeUntil](https://rxjs.dev/api/operators/takeUntil)
- [Moment.js](https://momentjs.com/docs/)

### Контакты
Для вопросов по компоненту обращайтесь к команде разработки или создавайте issue в репозитории проекта.

